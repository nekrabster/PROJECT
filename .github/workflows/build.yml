name: Build .exe with Nuitka

on:
  push:
    branches:
      - main

jobs:
  build:
    runs-on: windows-latest

    steps:
      - name: üßæ Checkout repository
        uses: actions/checkout@v4

      - name: üêç Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.12'

      - name: üßπ Clear pip cache
        run: |
          python -m pip cache purge

      - name: üì¶ Install dependencies (–∂—ë—Å—Ç–∫–æ)
        run: |
          python -m pip install --upgrade pip
          pip install nuitka==2.6
          pip install requests aiogram aiofiles packaging PySocks Pillow faker aiohttp_socks qasync telethon PyQt6 phonenumbers aiosmtplib pandas psutil certifi

      - name: üîç –ù–∞–π—Ç–∏ –ø—É—Ç—å –∫ certifi.pem
        id: find_certifi
        shell: pwsh
        run: |
          $path = python -c "import certifi; print(certifi.where())"
          echo "certifi_pem=$path" >> $env:GITHUB_OUTPUT

      - name: üìÅ –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å certifi.pem –≤ –∫–æ—Ä–µ–Ω—å
        id: copy_certifi
        shell: pwsh
        run: |
          Copy-Item -Path "${{ steps.find_certifi.outputs.certifi_pem }}" -Destination "certifi.pem"
          echo "certifi_local=certifi.pem" >> $env:GITHUB_OUTPUT

      - name: üîç Find python313.dll automatically
        id: find_dll
        shell: pwsh
        run: |
          $pythonRoot = "${{ env.pythonLocation }}"
          $dllPath = Get-ChildItem -Path "$pythonRoot" -Recurse -Filter python313.dll |
                     Select-Object -First 1 -ExpandProperty FullName
          echo "dll-path=$dllPath" >> $env:GITHUB_OUTPUT

      - name: üßπ Remove old dist (–Ω–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π)
        shell: cmd
        run: |
          if exist dist rmdir /s /q dist

      - name: üõ† Build .exe with Nuitka
        shell: pwsh
        run: |
          nuitka `
            --standalone `
            --onefile `
            --remove-output `
            --output-dir=dist `
            --output-filename=Soft-K `
            --windows-icon-from-ico=icon.ico `
            --assume-yes-for-downloads `
            --include-data-dir=icons=icons `
            --include-data-file=certifi.pem=certifi/cacert.pem `
            --include-module=requests `
            --include-module=aiofiles `
            --include-module=packaging `
            --include-module=socks `
            --include-module=PIL `
            --include-module=faker `
            --include-module=aiohttp_socks `
            --include-module=qasync `
            --include-module=aiogram `
            --include-module=telethon `
            --include-module=telethon.sync `
            --include-module=phonenumbers `
            --include-module=aiosmtplib `
            --include-module=pandas `
            --include-module=psutil `
            --include-module=PyQt6.QtMultimedia `
            --include-module=PyQt6.QtMultimediaWidgets `
            --include-module=ui.rudich `
            --include-module=ui.bombardirocrocodilo `
            --include-module=ui.complas `
            --include-module=ui.kachok `
            --include-module=ui.subscribe `
            --include-module=ui.malining `
            --include-module=ui.malina `
            --include-module=ui.components `
            --include-module=ui.session `
            --include-module=ui.rass `
            --include-module=ui.check `
            --include-module=ui.newtoken `
            --include-module=ui.okak `
            --include-module=ui.informatika `
            --include-module=ui.bombardo `
            --include-module=ui.sim_manager `
            --include-module=ui.loader `
            --include-module=ui.search `
            --include-module=ui.session_manager `
            --include-module=ui.session_win `
            --include-module=ui.apphuy `
            --include-module=ui.appchuy `
            --include-module=ui.timer `
            --include-module=ui.progress `
            --include-module=ui.samit `
            --include-module=ui.proxy_utils `
            --include-module=ui.mail `
            --include-module=ui.instructions `
            --include-module=ui.subs `
            --include-module=ui.damkrat `
            --include-module=ui.theme `
            --include-module=ui.styles `
            --include-module=ui.top `
            --include-module=ui.side `
            --include-module=ui.thread_base `
            --include-module=ui.mate `
            --include-module=ui.bottom `
            --include-module=ui.bot_manager `
            --include-module=ui.bot_transfer `
            --include-module=ui.table_manager_base `
            --include-module=ui.bots_win `
            --include-module=ui.gulick `
            --include-module=ui.kms `
            --include-module=ui.integraly `
            --include-module=ui.codik `
            --include-module=ui.adv `
            --include-module=ui.decorators `
            --include-module=ui.filya `
            --include-package-data=certifi `
            --include-module=email.mime.text `
            --include-module=email.mime.base `
            --include-module=email.mime.multipart `
            main.py

      - name: üßπ Remove all .py and .pyc from ui/ (–∂—ë—Å—Ç–∫–æ)
        shell: pwsh
        run: |
          Get-ChildItem "ui" -Recurse -Include *.py,*.pyc -Force |
            Remove-Item -Force

      - name: ‚òÅÔ∏è Upload .exe as artifact
        uses: actions/upload-artifact@v4
        with:
          name: Soft-K.exe
          path: dist\Soft-K.exe
          retention-days: 1
