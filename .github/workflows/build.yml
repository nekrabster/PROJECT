name: Build .exe with Nuitka

on:
  push:
    branches:
      - main

jobs:
  build:
    runs-on: windows-latest
    strategy:
      matrix:
        job_index: [0, 1, 2, 3]  # 4 parallel jobs
      fail-fast: false

    steps:
      - name: 🧾 Checkout repository
        uses: actions/checkout@v4

      - name: 🐍 Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.13'

      - name: 📦 Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install nuitka zstandard

      - name: 🔄 Delete existing .py files
        shell: pwsh
        run: |
          Get-ChildItem "ui" -Recurse -Include *.py -Force | Remove-Item -Force

      - name: 🛠️ Compile with Nuitka
        run: |
          python -m nuitka --onefile --windows-disable-console --windows-icon=icon.ico `
          --output-filename=Soft-K.exe --jobs=4 --lto=yes --python-flag=-OO `
          --enable-plugin=pyqt6 --include-package=ui --include-module=bombardirocrocodilo `
          --include-module=complas --include-module=components --include-module=malining `
          --include-module=malina --include-module=newtoken --include-module=kachok `
          --include-module=session --include-module=subscribe --include-module=session_manager `
          --include-module=sim_manager --include-module=session_win --include-module=bombardo `
          --include-module=okak --include-module=rass --include-module=timer --include-module=progress `
          --include-module=thread_base --include-module=apphuy --include-module=appchuy `
          --include-module=search --include-module=proxy_utils --include-module=mail `
          --include-module=instructions --include-module=subs --include-module=damkrat `
          --include-module=theme --include-module=styles --include-module=top --include-module=side `
          --include-module=bottom --include-module=informatika --include-module=bot_transfer `
          --include-module=bot_manager --include-module=bots_win --include-module=gulick `
          --include-module=integralypro --include-module=kms --include-module=integraly `
          --include-module=codik --include-module=adv --include-module=decorators --include-module=filya `
          --include-data-dir=icons=icons --include-data-file=icon.ico `
          --experimental=use_pefile --experimental=use_pefile_recurse `
          --noinclude-custom-mode=error --warn-implicit-exceptions `
          --file-reference-choice=runtime --assume-yes-for-downloads `
          --follow-stdlib --remove-output main.py

      - name: 📦 Package executable
        run: |
          mkdir dist
          copy Soft-K.exe dist

      - name: ☁️ Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: Soft-K-${{ matrix.job_index }}.exe
          path: dist/Soft-K.exe
          retention-days: 1

  cleanup:
    runs-on: ubuntu-latest
    if: github.event_name == 'push'
    steps:
      - name: 🧽 Delete old artifacts
        uses: actions/github-script@v7
        with:
          script: |
            const daysOld = 7;
            const artifacts = await github.rest.actions.listArtifactsForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
            });
            const now = new Date();
            for (const artifact of artifacts.data.artifacts) {
              const createdAt = new Date(artifact.created_at);
              const ageInDays = (now - createdAt) / (1000 * 60 * 60 * 24);
              if (artifact.name.startsWith('Soft-K-') && ageInDays > daysOld) {
                await github.rest.actions.deleteArtifact({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  artifact_id: artifact.id,
                });
              }
            }
