name: Build .exe with Nuitka (Python 3.13 + MSVC + Optimization)

on:
  push:
    branches: [main]

jobs:
  build:
    runs-on: windows-latest

    steps:
      - name: üßæ Checkout repository
        uses: actions/checkout@v4

      - name: üßπ Clean icons directory
        run: |
          Remove-Item -Path "icons\.DS_Store" -Force -ErrorAction SilentlyContinue
          Remove-Item -Path "icons\Thumbs.db" -Force -ErrorAction SilentlyContinue

      - name: üêç Setup Python 3.13
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'
          cache: 'pip'

      - name: üì¶ Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install "nuitka==2.7.7"

      - name: üîç Check Python and Nuitka versions
        run: |
          python --version
          python -m nuitka --version

      - name: üíæ Check disk space
        run: dir C:\

      - name: üß∞ Setup MSVC environment
        uses: ilammy/msvc-dev-cmd@v1

      - name: üîé Check MSVC version
        shell: cmd
        run: cl.exe

      - name: üõ† Build with Nuitka using MSVC
        shell: pwsh
        env:
          PYTHONIOENCODING: "utf-8"
          PYTHONLEGACYWINDOWSSTDIO: "utf-8"
          CL: /MD
          NUITKA_CACHE_DIR: C:\nuitka_cache
        run: |
          python -m nuitka main.py `
            --onefile`
            --standalone`
            --enable-plugin=pyqt6`
            --output-dir=dist`
            --remove-output`
            --no-pyi-file`
            --msvc=latest`
            --jobs=3`  # –í—Ä–µ–º–µ–Ω–Ω–æ —É–º–µ–Ω—å—à–∏—Ç—å
            --windows-icon-from-ico=icon.ico`
            --windows-company-name="SecureSoft"`
            --windows-product-name="Soft-K"`
            --windows-product-version="2.3.6"`
            --windows-disable-console`
            --output-filename=Soft-K.exe`
            --follow-imports`
            --include-data-dir=icons=icons`
            --assume-yes-for-downloads`
            --show-scons`
            --python-flag=no_warnings`
            --include-module=ui.rudich`
            --include-module=ui.complas`
            --include-module=ui.components`
            --include-module=ui.malining`
            --include-module=ui.malina`
            --include-module=ui.bombardirocrocodilo`
            --include-module=ui.newtoken`
            --include-module=ui.kachok`
            --include-module=ui.session`
            --include-module=ui.subscribe`
            --include-module=ui.session_manager`
            --include-module=ui.sim_manager`
            --include-module=ui.session_win`
            --include-module=ui.bombardo`
            --include-module=ui.okak`
            --include-module=ui.rass`
            --include-module=ui.timer`
            --include-module=ui.progress`
            --include-module=ui.thread_base`
            --include-module=ui.apphuy`
            --include-module=ui.appchuy`
            --include-module=ui.search`
            --include-module=ui.proxy_utils`
            --include-module=ui.mail`
            --include-module=ui.instructions`
            --include-module=ui.subs`
            --include-module=ui.damkrat`
            --include-module=ui.theme`
            --include-module=ui.styles`
            --include-module=ui.top`
            --include-module=ui.side`
            --include-module=ui.bottom`
            --include-module=ui.informatika`
            --include-module=ui.bot_transfer`
            --include-module=ui.bot_manager`
            --include-module=ui.bots_win`
            --include-module=ui.gulick`
            --include-module=ui.integraly`
            --include-module=ui.kms`
            --include-module=ui.integralypro`
            --include-module=ui.codik`
            --include-module=ui.adv`
            --include-module=ui.filya`
            --include-module=ui.decorators

      - name: ‚òÅÔ∏è Upload .exe as artifact
        uses: actions/upload-artifact@v4
        with:
          name: Soft-K.exe
          path: dist/Soft-K.exe
          retention-days: 1

      - name: ‚òÅÔ∏è Upload Nuitka crash report
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: nuitka-crash-report
          path: nuitka-crash-report.xml
          retention-days: 1
